<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <title>designworkplan dino game</title>
        <link rel="stylesheet" href="../index.css" />
        <link rel="stylesheet" href="../directory.css" />
        <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.6.0.0.min.js"></script>
        <script src="../index.js"></script>
        <script src="../connection.js"></script>
        <script src="../weather.js"></script>
        <script src="../scenes.js"></script>
        <script src="../static/qrcode.min.js"></script>
        <script src="../static/moment.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tsparticles-engine@2.0.5/tsparticles.engine.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tsparticles-move-base@2.0.5/tsparticles.move.base.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tsparticles-plugin-emitters@2.0.5/tsparticles.plugin.emitters.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tsparticles-shape-circle@2.0.5/tsparticles.shape.circle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tsparticles-updater-color@2.0.5/tsparticles.updater.color.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tsparticles-updater-opacity@2.0.5/tsparticles.updater.opacity.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tsparticles-updater-out-modes@2.0.5/tsparticles.updater.out-modes.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/tsparticles-updater-size@2.0.5/tsparticles.updater.size.min.js"></script>
        <script src="../background.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro&family=Work+Sans:wght@500&display=swap" rel="stylesheet" />
    </head>
    <body class="gray-background">
        <div class="flex-hor">
            <div id="table-grid"></div>
            <div class="dir-side">
                <p class="dir-top-space">&nbsp;</p>
                <div class="dir-time">
                    <div>
                        <p class="dir-time__time"></p>
                        <p class="dir-time__date"></p>
                    </div>
                    <div class="dir-time__weather">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
                            <!--! Font Awesome Pro 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                            <path
                                fill="white"
                                d="M0 336c0 79.5 64.5 144 144 144H512c70.7 0 128-57.3 128-128c0-61.9-44-113.6-102.4-125.4c4.1-10.7 6.4-22.4 6.4-34.6c0-53-43-96-96-96c-19.7 0-38.1 6-53.3 16.2C367 64.2 315.3 32 256 32C167.6 32 96 103.6 96 192c0 2.7 .1 5.4 .2 8.1C40.2 219.8 0 273.2 0 336z"
                            />
                        </svg>
                        <p>Overwegig zonnig</p>
                    </div>
                </div>
                <div class="dir-map">
                    <h2 class="dir-map__title">Waar ben ik?</h2>
                    <img class="dir-map__img" src="/static/directory-demo.png" />
                </div>
                <div class="dir-description">
                    <h2 class="dir-description__title">Hoe vind ik mijn bestemming?</h2>
                    <p class="dir-description__content">
                        Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna
                        aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation. Lorem ipsum dolor sit amet, consectetuer
                        adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim
                        veniam, quis nostrud exerci tation
                    </p>
                </div>
            </div>
        </div>
    </body>

    <script>
        const params = new URLSearchParams(location.search);
        const imgTitle = params.get("imgTitle") || "Waar ben ik?";
        const imgUrl = params.get("imgUrl") || "/static/directory-demo.png";
        const descriptionTitle = params.get("descriptionTitle") || "Hoe vind ik mijn bestemming?";
        const description = params.get("description") || "Lorem ipsum";
        const directorySrc = params.get("directorySrc") || "https://dashboard-directory.designworkplan.weboot.nl/items/Directory?limit=-1";

        function refreshTime() {
            let now = new Date();
            let m = moment();
            let timeElement = document.getElementsByClassName("dir-time__time")[0];
            let dateElement = document.getElementsByClassName("dir-time__date")[0];
            timeElement.innerText = m.format("HH:mm");
            dateElement.innerText = m.format("dddd, D MMMM");
        }

        function hourlyRefresh() {
            refreshWeather();
        }

        async function refreshWeather() {
            let weatherElement = document.querySelector(".dir-time__weather > p");
            let description = await getWeatherDescription();
            if (!description) return;

            description = description[0].toUpperCase() + description.slice(1);
            weatherElement.innerText = description;
        }

        function createRow(items, header = false) {
            let trEl = document.createElement("tr");
            for (let i of items) {
                let cellEl = document.createElement(header ? "th" : "td");
                cellEl.innerText = i;
                trEl.appendChild(cellEl);
            }
            return trEl;
        }
        async function setupDirectory(data) {
            let perColumn = new Map();
            let maxItemsPerColumn = Math.floor(window.innerHeight / 40);
            console.log("maxItemsPerColumn", maxItemsPerColumn);
            for (let i = 0; i < data.length; i++) {
                let row = data[i];
                let column = Math.floor(i / maxItemsPerColumn);
                let rowEl = createRow([row.destination, row.department, row.route]);
                if (perColumn.has(column)) {
                    perColumn.get(column).querySelector("tbody").appendChild(rowEl);
                } else {
                    let headerEl = createRow(["Bestemming", "Afdeling", "Route"], true);
                    let theadEl = document.createElement("thead");
                    theadEl.appendChild(headerEl);
                    let tbodyEl = document.createElement("tbody");
                    tbodyEl.appendChild(rowEl);
                    let tableEl = document.createElement("table");
                    tableEl.appendChild(theadEl);
                    tableEl.appendChild(tbodyEl);
                    let divEl = document.createElement("div");
                    divEl.appendChild(tableEl);
                    perColumn.set(column, divEl);
                }
            }
            let gridEl = document.getElementById("table-grid");
            let gridTemplate = [];
            for (let [col, el] of Array.from(perColumn.entries()).sort(([ka], [kb]) => ka - kb)) {
                console.log("Column %d:", col, el);
                gridEl.appendChild(el);
                gridTemplate.push("1fr");
            }
            gridEl.style.gridTemplateColumns = gridTemplate.join(" ");
        }

        async function setupDirectoryFrom(src) {
            let res = await fetch(src);
            if (!res.ok) {
                console.error("Could not get directory", res.status, await res.text());
                return;
            }
            let data = await res.json();
            setupDirectory(data.data);
        }

        document.addEventListener("DOMContentLoaded", () => {
            refreshTime();
            setInterval(refreshTime, 1000);

            hourlyRefresh();
            setInterval(hourlyRefresh, 1000 * 60 * 60);

            setupDirectoryFrom(directorySrc);

            document.querySelector(".dir-map__title").innerText = imgTitle;
            document.querySelector(".dir-map__img").src = imgUrl;
            document.querySelector(".dir-description__title").innerText = descriptionTitle;
            document.querySelector(".dir-description__content").innerText = description;
        });
    </script>
</html>
